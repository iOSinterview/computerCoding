# 项目面试问题

---

## 这个项目的亮点 / 项目过程中遇到了什么困难？怎么解决的？

### 1、帖子评论以及评论回复功能的实现

用户不仅可以评论帖子，还可以对帖子中的评论进行回复，同时我在获取帖子的评论列表的时候，评论会以多级的形式返回。

因为刚开始需求分析的时候，只是粗略确定了要实现评论以及查询评论的功能，并没有考虑到 用户还需要回复评论。写完后有一天看短视频里面有评论，突然才想起来要有回复评论的功能。

于是我重新设计了 `comment`表，增加了一个`parentID`字段，用来标识当前评论的父评论。如果这个字段为0，那么当前评论就是`父评论`，否则则为`子评论`。

因此获取评论的路由后，我会获取当前的用户ID、postID以及根据当前请求`parentID`是否为0，来判断是评论还是回复评论。

并且，在获取帖子所有的评论列表时，从数据库查询到当前帖子的所有评论后，会进行一个分类，先将所有父评论找出来，再找出每个父评论下对应的子评论。然后返回给前端。

## 2、热门帖子的缓存设计

考虑到存在一些帖子比较热门，用户访问量大，我在redis里面设计这样的`key-value`

- 缓存`postID`和对应的`score`。采用的是`Zset`结构，这样我们可以随时获取热门的前多少名帖子，减少MySQL查询。
- 缓存`postID`和对应的`create_time`。也是采用`Zset`结构，这样可以方便最新发布的帖子ID。
- 同时，针对热门帖子，进一步做了设计，每隔一段时间（设置定时任务），我会将当前前`n`名的热门帖子的整个内容都加入到缓存中，这样用户访问热门帖子的时候，可以加快访问速度。

`redis`中的数据结构如下：

![postkey](https://s2.loli.net/2024/08/21/BtHTw1zphcR6YPU.jpg)

![votekey](https://s2.loli.net/2024/08/21/MdHWfVY5O8SBqx2.jpg)

## 3、更新热门帖子时数据库与缓存的一致性设计

**由于引入了缓存，那么在进行数据更新时，不仅需要对MySQL数据库进行更新，还需要对`Redis缓存`进行更新，这两个更新操作存在一个前后问题。**

比如再修改帖子（不一定热门）内容时，

我【先更新数据库，再更新缓存】，这样的话，优点时我可以保证数据库中是最新的数据，其次由于缓存的更新缓存速度非常快，绝大程度上不会出现并发问题。

但是，这里存在两个问题：

- 如果缓存更新失败，而且修改的刚好是热门数据，那么大部分用户访问的将是缓存中的旧值。
- 同样地，如果刚好修改的是热门帖子，并发访问量很大，那么还没来得及更新缓存，也会数据不一致。

于是我想【先更新缓存，再更新数据库】，但是也会出现如下问题：

- 同样是如果数据库更新失败，且不是热门帖子，但是刚好有查询，缓存中没有，只能读数据库，读取的是旧值。
- 其次，如果即便修改的是这一段时间内的热门帖子，但是马上新的一轮热门帖子更新，而这个被挤下去了（失效），缓存中没有，但是此时还没来得及更新数据库，有一个请求访问数据库，那么就会读取的旧数据。

最后我思考了一下，还是采取了第二种方案：【先更新缓存，再更新数据库】，但是我加了充实机制以及Go中的`互斥锁(Mutex)`机制。

- 当前 goroutine 需要对帖子修改时，获取锁，保证此时只有一个`goroutine`对访问数据，并且都修改成功后释放锁。
- 对于保证第二步成功，可以使用`消息队列`，将更新数据库加入到消息队列中，

## 用redis实现百万用户游戏积分榜

redis是一个高性能的内存数据存储系统，对于游戏积分排行榜来说非常适合。可以通过以下步骤来实现百万用户有i下积分排行榜：

1. 使用redis的 Sorted Set数据结构存储用户积分；将userID作为成员，积分作为分数，每当用户积分变化时，通过ZADD命令进行更新。
2. 使用 ZREVRANGE 命令获取排行榜：该命令可以根据分数的降序返回成员，从而实现排行榜。
3. 使用Hash存储用户详细信息：将userID作为key，用户详细信息UserInfo（用户名、头像等）作为value，通过 HGET命令快速获取用户详细信息。

这样，通过有序集合和哈希数据结构的结合，就可以实现高效、稳定的百万用户游戏的积分榜。

