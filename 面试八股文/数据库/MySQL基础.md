



[TOC]

# MySQL的基础架构

（一条select语句执行的流程）

总体架构图：

![MySQL基础架构](https://s2.loli.net/2024/08/16/uWQtjdp5JeBFvkl.png)

MySQL的架构主要分为两层：Server层和存储引擎层

- **Server层负责建立连接、分析和执行SQL。**主要包括连接器，查询缓存、解析器、预处理器、优化器、执行器等。另外，所有的内置函数（如日期、时间、数学和加密函数等）和所有跨存储引擎的功能（如存储过程、触发器、视图等。）都在 Server 层实现。
- **存储引擎层负责数据的存储和提取**。支持 InnoDB、MyISAM、Memory 等多个存储引擎，不同的存储引擎共用一个 Server 层。

## 第一步：连接器

连接器负责跟客户端建立连接、获取权限、维持和管理连接。当身份认证完成以后，如果没有后序操作，连接会进入空闲状态，但`wait_timeout`过期时，连接器会关闭该连接。

连接MySQL服务通过以下命令：

```shell
# -h 指定 MySQL 服务得 IP 地址，如果是连接本地的 MySQL服务，可以不用这个参数；
# -u 指定用户名，管理员角色名为 root；
# -p 指定密码，如果命令行中不填写密码（为了密码安全，建议不要在命令行写密码），就需要在交互对话里面输入密码
mysql -h $ip -u$user -p
```

MySQL基于TCP建立连接，因此需要经过TCP三次握手。

MySQL中的来凝结跟HTTP一样，有长短连接，一般是使用长连接，但是长连接过多是会导致内存占用更大，被系统强行杀掉（OOD），即MySQL异常重启。

```c
// 短连接
连接 mysql 服务（TCP 三次握手）
执行sql
断开 mysql 服务（TCP 四次挥手）

// 长连接
连接 mysql 服务（TCP 三次握手）
执行sql
执行sql
....
断开 mysql 服务（TCP 四次挥手）
```

怎么解决这个问题呢？你可以考虑以下两种方案。

1. **定期断开长连接。**使用一段时间，或者程序里面判断执行过一个占用内存的大查询后，断开连接，之后要查询再重连。
2. **客户端主动重置连接。**可以在每次执行一个比较大的操作后，通过执行 mysql_reset_connection来重新初始化连接资源。这个过程不需要重连和重新做权限验证，但是会将连接恢复到刚刚创建完时的状态。

总结：

- 与客户端进行 TCP 三次握手建立连接；
- 校验客户端的用户名和密码，如果用户名或密码不对，则会报错；
- 如果用户名和密码都对了，会读取该用户的权限，然后后面的权限逻辑判断都基于此时读取到的权限；

## 第二步：查询缓存

如果要执行的SQL语句是`select`查询语句，MySQL会先去查询缓存。**但其实查询缓存的命中率非常低，因为对于更新比较频繁的表，因为只要一个表有更新操作，那么这个表的查询缓存就会被清空。如果刚缓存了一个查询结果很大的数据，还没被使用的时候，刚好这个表有更新操作，查询缓冲就被清空了。**除非业务需要的就是一张静态表，很长时间才会更新一次。比如，一个系统配置表，那这张表上的查询才适合使用查询缓存。

**需要注意的是，MySQL 8.0版本直接将查询缓存的整块功能删掉了，也就是说8.0开始彻底没有这个功能了。**

## 第三步：解析器

在正式执行SQL语句查询前，MySQL中的解析器会先对SQL语句做解析，了解客户端输入的是什么需求，即连接需求。主要会做两件事。

- 解析器先会做`词法分析`。需要识别出里面的字符串分别是什么、代表什么，也就是识别关键字。
- 接着做`语法分析`。根据`词法分析`的结果，`语法分析`会根据语法规则，判断当前的SQL语句是否合法，然后构建语法树，方便后续模块读取表名、字段、语句类型。

## 第四步：执行SQL

接着就要进入执行 SQL 查询语句的流程了，每条`SELECT` 查询语句流程主要可以分为下面这三个阶段：

- prepare 阶段，也就是预处理阶段；
- optimize 阶段，也就是优化阶段；
- execute 阶段，也就是执行阶段；

### 预处理阶段

- 检查 SQL 查询语句中的表或者字段是否存在；
- 将 `select *` 中的 `*` 符号，扩展为表上的所有列；

### 优化器

**优化器主要负责将 SQL 查询语句的执行方案确定下来**，比如在表里面有多个索引的时候，优化器会基于查询成本的考虑，来决定选择使用哪个索引。

### 执行器

根据执行计划执行 SQL 查询语句，从存储引擎读取记录，返回给客户端；

## 总结

- 连接器：建立、管理连接、校验用户身份；
- 查询缓存：查询语句如果命中查询缓存则直接返回，否则继续往下执行。MySQL 8.0 已删除该模块；
- 解析 SQL，通过解析器对 SQL 查询语句进行词法分析、语法分析，然后构建语法树，方便后续模块读取表名、字段、语句类型；
- 执行 SQL：执行 SQL 共有三个阶段：
  - 预处理阶段：检查表或字段是否存在；将 `select *` 中的 `*` 符号扩展为表上的所有列。
  - 优化阶段：基于查询成本的考虑， 选择查询成本最小的执行计划；
  - 执行阶段：根据执行计划执行 SQL 查询语句，从存储引擎读取记录，返回给客户端；

![MySQL基础架构](https://s2.loli.net/2024/08/16/nlGyPqhBbJmT4Xd.png)
